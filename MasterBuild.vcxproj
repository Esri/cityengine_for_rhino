<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>15.0</VCProjectVersion>
    <ProjectGuid>{3834552A-23FC-4584-850C-D823CA9F4227}</ProjectGuid>
    <RootNamespace>MasterBuild</RootNamespace>
    <WindowsTargetPlatformVersion>10.0.17763.0</WindowsTargetPlatformVersion>
  </PropertyGroup>

  <PropertyGroup>
    <PRTUrl>https://github.com/Esri/cityengine-sdk/releases/download/2.3.6821/esri_ce_sdk-2.3.6821-win10-vc142-x86_64-rel-opt.zip</PRTUrl>
    <ArchiveName>esrisdk.zip</ArchiveName>
    <OutputDirectory>.\buid\</OutputDirectory>
    <DownloadDir>$(SolutionDir)Downloads\</DownloadDir>
  </PropertyGroup>

  <Target Name="DownloadPRT" BeforeTargets="Build">
    <Message Importance="High" Text="Downloading Esri SDK" />
    <DownLoadFile
      SourceUrl="$(PRTUrl)"
      DestinationFolder="$(DownloadDir)"
      SkipUnchangedFiles="true">
      <Output TaskParameter="DownloadedFile" ItemName="esri_sdk_zip" />
    </DownLoadFile>
    <Message Importance="High" Text="Finished download of '@(esri_sdk_zip)'"/>
    <Unzip SourceFiles="@(esri_sdk_zip)" DestinationFolder="$(SolutionDir)esri_sdk\" SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true" />
  </Target>

  <Target Name="Build">
    <Message Importance="High" Text="Starting Build" />
    <MSBuild Projects="codecs_rhino\codecs_rhino.vcxproj" Targets="Build" />
    <MSBuild Projects="RhinoPRT\RhinoPRT.vcxproj" Targets="Build" Properties="Configuration=Release" />
    <MSBuild Projects="RhinoPRT\RhinoPRT.vcxproj" Targets="Build" Properties="Configuration=Release_gh" />
    <MSBuild Projects="GrasshopperPRT\GrasshopperPRT.csproj" Targets="Build" Properties="Configuration=Release_gh;Platform=AnyCPU"/>
    <Message Importance="High" Text="Build finished" />
  </Target>

  <Target Name="CopyDLLs" AfterTargets="Build">
    <ItemGroup>
      <RhinoPRTFiles Include="x64\Release\RhinoPRT.rhp;x64\Release\GrasshopperPRT.gha;x64\Release\RhinoPRT.dll" />
      <Codec Include="x64\Release\codecs_rhino.dll"/>
      <Sdk_Dlls Include=".\esri_sdk\bin\*.dll" />
      <libDir Include="$(SolutionDir)esri_sdk\lib\" />
      <libs Include="$(SolutionDir)esri_sdk\lib\VueExport.dll;$(SolutionDir)esri_sdk\lib\com.esri.prt.adaptors.dll;$(SolutionDir)esri_sdk\lib\com.esri.prt.codecs.dll" />
    </ItemGroup>
    <Message Importance="High" Text="Copying dlls..." />
    <!-- Copy SDK files to Release folder -->
    <Copy
      SourceFiles="@(Sdk_Dlls)"
      DestinationFolder=".\build\bin"
    />
    <Copy
      SourceFiles="@(libs)"
      DestinationFolder=".\build\lib"
    />
  </Target>

  <Target Name="Clean">
    <RemoveDir Directories="$(OutputDirectory)">
      <Output TaskParameter="RemovedDirectories" ItemName="DeletedDirs"/>
    </RemoveDir>
    <Message Importance="High" Text="Deleted folders: '@(DeletedDirs)'"/>
  </Target>

</Project>
